<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Scanner un indice | HollyBlood</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body {
      background-color: #111;
      color: #f5f5f5;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      text-align: center;
      padding: 2em;
      position: relative;
    }
    h1 {
      font-size: 2.5em;
      margin-bottom: 0.2em;
    }
    p {
      font-size: 1.2em;
      color: #ccc;
      margin-bottom: 2em;
    }
    button {
      background-color: #ff0000;
      color: white;
      border: none;
      padding: 1em 2em;
      font-size: 1.2em;
      border-radius: 8px;
      cursor: pointer;
      margin: 1em 0.5em;
      box-shadow: 0 0 10px #ff0000;
      transition: transform 0.2s ease, background-color 0.3s ease;
    }
    button:hover {
      transform: scale(1.05);
      background-color: #cc0000;
    }
    .aide {
      background-color: #1f1f1f;
      border: 1px solid #333;
      padding: 1.5em;
      margin-top: 2em;
      width: 90%;
      max-width: 650px;
      display: none;
      border-radius: 10px;
      text-align: left;
      color: #ddd;
      margin-left: auto;
      margin-right: auto;
    }
    select {
      width: 100%;
      max-width: 400px;
      padding: 0.7em;
      font-size: 1em;
      background-color: #222;
      color: #fff;
      border: 1px solid #555;
      border-radius: 6px;
      margin: 0.5em 0 1em;
      appearance: none;
    }
    select:focus {
      outline: none;
      border-color: #ff0000;
    }
    label {
      font-weight: bold;
      margin-top: 1em;
      display: block;
    }
    #indiceAffiche {
      margin-top: 3em;
      font-size: 1.4em;
      background-color: #222;
      padding: 1.5em;
      border-radius: 10px;
      max-width: 650px;
      margin-left: auto;
      margin-right: auto;
      box-shadow: 0 0 20px #ff0000;
      color: #0f0;
      display: none;
    }
    #btnAide {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background-color: #444;
      color: white;
      font-size: 1.8em;
      padding: 0.4em 0.7em;
      border-radius: 50%;
      cursor: pointer;
      border: none;
      box-shadow: 0 0 10px #000;
    }
    #btnAide:hover {
      background-color: #666;
    }
    .btn-retour {
      margin-top: 3em;
    }
    #reader {
      width: 300px;
      margin: 2em auto;
      display: none;
    }
  </style>
</head>
<body>
  <h1>üîç Scanner un indice</h1>
  <p>Sc√©nario en cours : <strong id="scenarioNom">...</strong></p>
  <p>Scanne ta carte fouille pour r√©v√©ler un indice dans cette pi√®ce.</p>

  <button onclick="demarrerQrCode()">üì∏ Scanner ma carte fouille</button>

  <div id="reader"></div>

  <div class="aide" id="aideBloc">
    <p><strong>‚ö†Ô∏è Si le scan ne fonctionne pas :</strong></p>

    <label for="pieceSelect">1. Choisissez la pi√®ce que vous fouillez :</label>
    <select id="pieceSelect">
      <option value="">-- S√©lectionner une pi√®ce --</option>
      <option>Atelier_costumes</option>
      <option>Bureau_du_producteur</option>
      <option>Centre_de_conf√©rence</option>
      <option>Entrep√¥t_des_scripts</option>
      <option>Hall_des_stars</option>
      <option>Loge_des_acteurs</option>
      <option>Salle_de_pr√©paration_des_performances</option>
      <option>Secteur_Maquillage_et_coiffure</option>
      <option>Studio_215</option>
    </select>

    <label for="niveauSelect">2. Choisissez le niveau de votre carte fouille :</label>
    <select id="niveauSelect">
      <option value="">-- S√©lectionner un niveau --</option>
      <option>L√©ger</option>
      <option>Moyen</option>
      <option>Pr√©cis</option>
      <option>Crucial</option>
    </select>

    <button onclick="afficherIndiceManuel()">üéØ Afficher l‚Äôindice</button>
  </div>

  <button id="btnAide" onclick="toggleAide()">‚ùì</button>
  <div id="indiceAffiche"></div>
  <button class="btn-retour" onclick="retourAuScenario()">‚Ü©Ô∏è Retour au sc√©nario</button>

  <script>
    const params = new URLSearchParams(window.location.search);
    const scenario = (params.get("scenar") || "aa1").toLowerCase(); // ‚úÖ En minuscule
    document.getElementById("scenarioNom").textContent = scenario;

    function toggleAide() {
      const bloc = document.getElementById("aideBloc");
      bloc.style.display = bloc.style.display === "none" ? "block" : "none";
    }

    function decoderNiveau(input) {
      const code = input.toLowerCase();
      if (code.includes("l√©ger")) return "L√©ger";
      if (code.includes("moyen")) return "Moyen";
      if (code.includes("pr√©cis")) return "Pr√©cis";
      if (code.includes("crucial")) return "Crucial";
      return null;
    }

    function afficherIndice(nomFichier) {
      const bloc = document.getElementById("indiceAffiche");
      bloc.style.display = "block";
      bloc.textContent = nomFichier;
    }

    function afficherIndiceManuel() {
      const piece = document.getElementById("pieceSelect").value;
      const niveau = document.getElementById("niveauSelect").value;
      if (!piece || !niveau) {
        alert("Veuillez choisir une pi√®ce et un niveau.");
        return;
      }
      document.getElementById("aideBloc").style.display = "none";
      afficherIndice(`${scenario}_${piece}_${niveau}.png`);
    }

    function retourAuScenario() {
      window.location.href = scenario + ".html";
    }

    function demarrerQrCode() {
      document.getElementById("reader").style.display = "block";
      const html5QrCode = new Html5Qrcode("reader");
      html5QrCode.start(
        { facingMode: "environment" },
        {
          fps: 10,
          qrbox: 250
        },
        (decodedText, decodedResult) => {
          html5QrCode.stop();
          document.getElementById("reader").style.display = "none";
          const niveau = decoderNiveau(decodedText);
          if (!niveau) {
            alert("QR code non reconnu. Niveau introuvable.");
            return;
          }
          const piece = prompt("Scannez ou entrez la pi√®ce fouill√©e (ex : Loge_des_acteurs)")?.replaceAll(" ", "_");
          if (!piece) return;
          afficherIndice(`${scenario}_${piece}_${niveau}.png`);
        },
        (errorMessage) => {
          // console.log(`Erreur de scan : ${errorMessage}`);
        }
      );
    }
  </script>
</body>
</html>
